<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANY</title>
    <style>
    canvas{
            border: 2px solid black;
    }
    #died{
        display: none;
    }
    #pauseBTN{
        width: fit-content;
        height: fit-content;
        padding: 4px;
        background-color: lightblue;
        border: 2px solid black;
        border-radius: 4px;
        user-select: none;
        cursor: pointer;
    }
    @media screen and (max-width: 1290px) {
        button{
            width: 25vw;
            height: 5vh;
            margin: 0;
            font-size: xx-large;
        }
        p{
            font-size: xx-large;
        }
        
    }
    </style>
    </head>
<body>
<div onclick="pause()" id="pauseBTN">Start/Pause</div>
<p id="score">Score: 0</p><br>
<p id="debug"></p>
<canvas id="canvas"></canvas>

<script>
var die = false
var running = false
var canvWidth = 600
var canvHeight = 300
var ticks = 100
var score = 0
var canvas = document.getElementById("canvas")
var ctx = canvas.getContext("2d")
ctx.lineWidth = 2
canvas.height = canvHeight
canvas.width = canvWidth
var obstacles = []
var maxobs = 3
var flappy = new bird()
var obsta = new obs()
var dieTime = Date.now()
flappy.show()
obsta.create()
obsta.update()
var tickdelay = ( function() {
    timer = 0;
    return function(callback, ms) {
        clearTimeout (timer);
        timer = setTimeout(callback, ms);
    };
})();

tick()

function pause(){
    if(running)running = false
    else if(!die){
        running = true
        tick()
    }
    if(die){
        restart()
    }
}

function died(){
    pause()
    die = true
    dieTime = Date.now()
    obsta.show(true)
    canvas.style.cursor = "pointer"
    ctx.closePath()
    ctx.beginPath()
    ctx.fillStyle = "rgba(0,0,0,0.4)"
    ctx.fillRect(120,30,canvWidth-240,canvHeight-60)
    ctx.fillStyle = "#f77"
    //ctx.strokeStyle = "white"
    ctx.textAlign = "center"
    ctx.textBaseline = "middle"
    ctx.font = "50px Comic Sans MS"
    ctx.fillText("You crashed!", canvWidth/2,  canvHeight/4)
    ctx.strokeText("You crashed!", canvWidth/2,  canvHeight/4)
    ctx.font = "35px Verdana"
    ctx.fillText(`Score: ${score}`, canvWidth/2,  canvHeight/4*2)
    ctx.strokeText(`Score: ${score}`, canvWidth/2,  canvHeight/4*2)
    ctx.fillText(`Click to restart`, canvWidth/2,  canvHeight/4*3)
    ctx.strokeText(`Click to restart`, canvWidth/2,  canvHeight/4*3)
    ctx.closePath()
    //ctx.strokeStlye = "black"
}

function restart(){
    obstacles = []
    obsta = new obs()
    obsta.create()
    flappy = new bird()
    score = 0
    canvas.style.cursor = "default"
    die = false
    pause()
}

function tick(){tickdelay(function(){if(running){
    flappy.update()
    obsta.update()
    document.getElementById("score").innerHTML = `Score: ${score}`
    tick()
}}, 1000/ticks)}

function obs(){
    this.obswidth = 30
    this.maxheight = canvHeight
    this.minheight = 0
    this.mingap = flappy.radius*6
	this.maxgap = flappy.radius*10

    this.update = function(){
        this.move()
        this.manage()
        this.show()
    }

    this.create = function(){
        this.topheight = Math.floor(Math.random() * (this.maxheight - this.maxgap))
        this.gap = Math.floor(Math.random() * (this.maxgap-this.mingap) + this.mingap)
        this.bottomheight = this.topheight+this.gap
        this.obstacle = [[],[]]
        this.top = [canvWidth+2,-1,this.obswidth,this.topheight]
        this.bottom = [canvWidth+2, this.bottomheight, this.obswidth, canvHeight-this.bottomheight]
        this.obstacle[0] = this.top
        this.obstacle[1] = this.bottom
        obstacles.push(this.obstacle)
    }

    this.manage = function(){
        this.last = obstacles.length-1
        this.lasttop = obstacles[this.last][0]
        this.lastbottom = obstacles[this.last][1]
        this.topx = this.lasttop[0]
        this.obsgap = canvWidth/maxobs
        if(this.topx <= canvWidth-this.obsgap)this.create()
        this.firsttopx = obstacles[0][0][0]
        if(this.firsttopx+this.obswidth < 0){obstacles.splice(0,1);score++;}
    }

    this.move = function(){
        for(var i = 0; i < obstacles.length; i++){
            obstacles[i][0][0]--
            obstacles[i][1][0]--
        }
    }

    this.show = function(override = false){
        if(!die || override){
            for(var i = 0; i < obstacles.length; i++){
                ctx.fillStyle = `rgba(0,200,0,1)`
                ctx.fillRect(obstacles[i][0][0], obstacles[i][0][1], obstacles[i][0][2], obstacles[i][0][3])
                ctx.fillRect(obstacles[i][1][0], obstacles[i][1][1], obstacles[i][1][2], obstacles[i][1][3])
                ctx.strokeRect(obstacles[i][0][0], obstacles[i][0][1], obstacles[i][0][2], obstacles[i][0][3])
                ctx.strokeRect(obstacles[i][1][0], obstacles[i][1][1], obstacles[i][1][2], obstacles[i][1][3])
            }
        }
    }

}

function bird(x,y,radius){
    this.radius = radius || 15
    this.x = x || canvWidth*0.1
    this.y = y || canvHeight/2
    this.accel = 0
    this.died = false

    this.update = function(){
        this.fly()
        this.check()
        this.show()
        if(this.died) died()
    }

    this.show = function(){
        ctx.clearRect(0,0,canvWidth,canvHeight)
        ctx.beginPath()
        ctx.fillStyle = `rgba(255,160,30,1)`
        ctx.arc(this.x,this.y, this.radius, 0, 2*Math.PI)
        ctx.fill();
        ctx.stroke()
        ctx.closePath()
    }
    this.flap = function(){
        if(this.accel < 1) this.accel = 6
    }
    this.fly = function(){
        this.y = this.y-this.accel
        this.accel -= .5
        if(this.accel < -10) this.accel = -10
        if(this.y+this.radius > canvHeight){this.y = canvHeight-this.radius;}
        if(this.y - this.radius < -1 )this.y = this.radius -1

        //document.getElementById("debug").innerText = `Accel: ${this.accel} \n y = ${this.y}`
    }

    this.check = function(){
        this.topLeft = [obstacles[0][0][0], obstacles[0][0][3]]
        this.topRight = [obstacles[0][0][0] + obstacles[0][0][2], obstacles[0][0][3]]
        this.bottomLeft = [obstacles[0][1][0], obstacles[0][1][1]]
        this.bottomRight = [obstacles[0][1][0] + obstacles[0][1][2], obstacles[0][1][1]]
        
        /* console.log(`TOP LEFT: x = ${this.topLeft[0]} ; y = ${this.topLeft[1]}`)
        console.log(`TOP RIGHT: x = ${this.topRight[0]} ; y = ${this.topRight[1]}`)
        console.log(`BOTTOM LEFT: x = ${this.bottomLeft[0]} ; y = ${this.bottomLeft[1]}`)
        console.log(`BOTTOM RIGHT: x = ${this.bottomRight[0]} ; y = ${this.bottomRight[1]}`)
        console.log(`BIRD: x = ${this.x} ; y = ${this.y}`) */

        this.topLeftDist = ((this.topLeft[0] - this.x)**2 + (this.topLeft[1] - this.y)**2 )**(1/2)
        this.topRightDist = ((this.topRight[0] - this.x)**2 + (this.topRight[1] - this.y)**2 )**(1/2)
        this.bottomLeftDist = ((this.bottomLeft[0] - this.x)**2 + (this.bottomLeft[1] - this.y)**2 )**(1/2)
        this.bottomRightDist = ((this.bottomRight[0] - this.x)**2 + (this.bottomRight[1] - this.y)**2 )**(1/2)
        
        if(this.topLeftDist < this.radius -2 || this.bottomLeftDist < this.radius -2 || this.topRightDist < this.radius -2 ||this.bottomRightDist < this.radius -2){this.died = true; return;}
        if((this.x+this.radius > this.topLeft[0] && this.y - this.radius > this.bottomLeft[1] && this.x - this.radius < this.topRight[0]) || (this.x+this.radius > this.topLeft[0] && this.y + this.radius < this.topLeft[1] && this.x - this.radius < this.topRight[0])){this.died = true; return;}
    }
}

let press = false

canvas.addEventListener("mousedown", ()=>{
    if(die && dieTime + 1000 < Date.now()){
        restart()
    } else if(!running && !die && !press){
        pause()
        flappy.flap()
    } else if(!press) {
        flappy.flap()
        press = true
    }
})
canvas.addEventListener("mouseup", ()=>{
    press = false
})

document.addEventListener("keydown", e => {
    var code = e.keyCode
    if(code == 32 && die && dieTime + 1000 < Date.now()){
        restart()
    } if(code == 32 && !running && !die && !press){
        pause()
        flappy.flap()
    } else if(code == 32 && !press){
        flappy.flap()
        press = true
    } else if (code == 27){
        pause();
    }
})

document.addEventListener("keyup", e => {
    var code = e.keyCode
    if(code == 32){
        press = false
    }
})

/* canvas.addEventListener("touch", e => {
    e.preventDefault()
    flappy.flap()
}) */
</script>
</body>
</html>